<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisa Saham Pro (Firebase)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" xintegrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Firebase Libraries -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, Timestamp, deleteDoc, doc, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        
        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyCO39W-uKdmyame7jnoE6yJYnJ5YXQcj6w",
          authDomain: "asap-1c718.firebaseapp.com",
          databaseURL: "https://asap-1c718-default-rtdb.firebaseio.com",
          projectId: "asap-1c718",
          storageBucket: "asap-1c718.firebasestorage.app",
          messagingSenderId: "751419629417",
          appId: "1:751419629417:web:bd6d3ac7533f984910a7f8",
          measurementId: "G-KENJD67NWJ"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Make functions and variables available globally on the window object
        window.db = db;
        window.auth = auth;
        window.firebase = {
            collection, addDoc, getDocs, query, where, Timestamp, deleteDoc, doc, signInAnonymously, onAuthStateChanged, orderBy, writeBatch
        };
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .positive-gain { color: #10B981; }
        .negative-gain { color: #EF4444; }
        .neutral-gain { color: #6B7280; }
        .tab-btn.active { border-color: #3B82F6; color: #2563EB; font-weight: 600; }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #2d3748; color: white; padding: 1rem 2rem; border-radius: 0.5rem; z-index: 100; opacity: 0; transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; transform: translate(-50%, 10px); }
        .toast.show { opacity: 1; transform: translate(-50%, 0); }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3498db; width: 40px; height: 40px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .time-filter-btn.active-filter { background-color: #3B82F6; color: white; }
        #manual-analysis-result h4 { font-size: 1.125rem; font-weight: 600; margin-top: 1rem; margin-bottom: 0.5rem; }
        #manual-analysis-result p { margin-bottom: 1rem; }
        .top-pick-highlight { background-color: #D1FAE5 !important; }
        .top-pick-highlight td:first-child { font-weight: bold; }
        /* Responsive table cell padding */
        .responsive-px { padding-left: 0.5rem; padding-right: 0.5rem; }
        @media (min-width: 640px) { .responsive-px { padding-left: 1.5rem; padding-right: 1.5rem; } }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            width: 90%;
            max-width: 400px;
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="app" class="container mx-auto p-4 md:p-8">

        <!-- Header -->
        <header class="mb-8">
             <div class="flex flex-col md:flex-row justify-between items-center bg-white p-4 sm:p-6 rounded-2xl shadow-lg">
                 <div class="flex items-center space-x-4">
                    <div class="bg-blue-600 p-3 rounded-full"><i class="fas fa-chart-line text-white text-xl sm:text-2xl"></i></div>
                    <div>
                        <h1 class="text-xl sm:text-2xl md:text-3xl font-bold text-gray-900">Analisa Saham Pro</h1>
                        <p id="current-date" class="text-gray-500 text-sm">Memuat data...</p>
                    </div>
                </div>
                 <div class="mt-4 md:mt-0 text-sm text-gray-600 flex items-center">
                    <i class="fab fa-google-drive mr-2 text-blue-500"></i>
                    <span>Didukung oleh Gemini AI</span>
                </div>
            </div>
        </header>
        
        <!-- Main Content -->
        <main>
            <!-- Tab Navigation -->
            <div class="mb-6"><div class="border-b border-gray-200"><nav class="-mb-px flex space-x-4 sm:space-x-8 text-sm sm:text-base" aria-label="Tabs"><button id="tab-btn-dashboard" class="tab-btn active whitespace-nowrap py-4 px-1 border-b-2 font-medium">Dashboard</button><button id="tab-btn-manual" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Analisis Manual</button><button id="tab-btn-tracking" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Lacak Manual</button></nav></div></div>
            
            <!-- Dashboard Tab -->
            <div id="tab-content-dashboard" class="tab-content">
                <section id="ai-recommendation-generator" class="mb-8 bg-white p-6 rounded-2xl shadow-lg text-center">
                    <h2 class="text-xl font-bold text-gray-800">Rekomendasi Saham Hari Ini</h2>
                    <p id="ai-recommendation-status" class="text-gray-500 mt-2 mb-4">Menganalisis pasar untuk rekomendasi hari ini...</p>
                    <button id="get-ai-recommendation-btn" class="bg-blue-600 text-white font-bold py-3 px-6 sm:px-8 rounded-lg hover:bg-blue-700 transition duration-300 text-sm sm:text-base">
                        <i class="fas fa-wand-magic-sparkles mr-2"></i> Dapatkan Rekomendasi AI
                    </button>
                </section>

                <section id="performance">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                        <div class="flex items-center gap-4 w-full md:w-auto">
                            <h2 class="text-xl font-bold text-gray-700">Lacak Performa AI</h2>
                            <button id="bulk-delete-ai-btn" class="hidden bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 text-sm">
                                <i class="fas fa-trash-alt mr-2"></i>Hapus Terpilih
                            </button>
                        </div>
                        <div id="time-filter" class="flex items-center bg-white rounded-lg shadow-sm p-1 space-x-1 w-full md:w-auto justify-center">
                            <button data-period="daily" class="time-filter-btn active-filter font-semibold py-2 px-4 rounded-md text-sm w-full">Harian</button>
                            <button data-period="weekly" class="time-filter-btn py-2 px-4 rounded-md text-sm w-full">Pekanan</button>
                            <button data-period="monthly" class="time-filter-btn py-2 px-4 rounded-md text-sm w-full">Bulanan</button>
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-500">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                                    <tr>
                                        <th scope="col" class="responsive-px py-3"><input type="checkbox" id="select-all-ai" class="rounded"></th>
                                        <th scope="col" class="responsive-px py-3">Saham</th>
                                        <th scope="col" class="responsive-px py-3">Tgl Rekomendasi</th>
                                        <th scope="col" class="responsive-px py-3 text-right">Harga Awal</th>
                                        <th scope="col" class="responsive-px py-3 text-right">Harga Terkini</th>
                                        <th scope="col" class="responsive-px py-3 text-right">Gain (%)</th>
                                        <th scope="col" class="responsive-px py-3 text-center">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="performance-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                    <!-- Pagination for AI Performance -->
                    <div id="ai-pagination" class="hidden mt-4 flex flex-col sm:flex-row items-center justify-between gap-2">
                        <span id="ai-page-info" class="text-sm text-gray-600 mb-2 sm:mb-0"></span>
                        <div class="flex gap-2">
                            <button id="ai-prev-page" class="bg-white border border-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed text-sm">&laquo; Sebelumnya</button>
                            <button id="ai-next-page" class="bg-white border border-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed text-sm">Berikutnya &raquo;</button>
                        </div>
                    </div>
                </section>
            </div>
            
            <!-- Manual Analysis Tab -->
            <div id="tab-content-manual" class="tab-content hidden">
                <section id="manual-analysis-section">
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h2 class="text-xl font-bold mb-2 text-gray-700">Analisis Saham Manual</h2>
                        <p class="text-sm text-gray-500 mb-6">Masukkan beberapa kode saham yang ingin Anda bandingkan, pisahkan dengan koma.</p>
                        <div>
                            <label for="manual-stock-input" class="block text-sm font-medium text-gray-700 mb-2">Kode Saham</label>
                            <textarea id="manual-stock-input" rows="3" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Contoh: TLKM, ASII, ADRO"></textarea>
                        </div>
                        <div class="mt-4 text-right">
                            <button id="manual-analyze-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition duration-300">
                                <i class="fas fa-search mr-2"></i> Bandingkan & Analisa
                            </button>
                        </div>
                    </div>
                    <div id="manual-analysis-result-container" class="mt-8">
                        <div id="manual-analysis-result" class="bg-white p-6 rounded-2xl shadow-lg min-h-[10rem]">
                            <p class="text-center text-gray-500">Hasil analisis perbandingan akan muncul di sini.</p>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Manual Tracking Tab -->
            <div id="tab-content-tracking" class="tab-content hidden">
                <section id="manual-tracking-section">
                    <div class="bg-white p-6 rounded-2xl shadow-lg mb-8">
                        <h2 class="text-xl font-bold mb-2 text-gray-700">Tambahkan Saham ke Daftar Lacak</h2>
                        <p class="text-sm text-gray-500 mb-6">Masukkan kode saham yang ingin Anda pantau performanya secara manual.</p>
                        <div class="flex flex-col sm:flex-row items-end space-y-2 sm:space-y-0 sm:space-x-4">
                            <div class="w-full"><label for="manual-track-input" class="block text-sm font-medium text-gray-700 mb-1">Kode Saham</label><input type="text" id="manual-track-input" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Contoh: MDKA"></div>
                            <button id="add-manual-track-btn" class="w-full sm:w-auto bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition duration-300 flex-shrink-0">
                                <i class="fas fa-plus mr-2"></i> Tambahkan
                            </button>
                        </div>
                    </div>
                     <div class="flex items-center gap-4 mb-4">
                        <h2 class="text-xl font-bold text-gray-700">Daftar Lacak Manual</h2>
                        <button id="bulk-delete-manual-btn" class="hidden bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 text-sm">
                            <i class="fas fa-trash-alt mr-2"></i>Hapus Terpilih
                        </button>
                    </div>
                    <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-500">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                                    <tr>
                                        <th scope="col" class="responsive-px py-3"><input type="checkbox" id="select-all-manual" class="rounded"></th>
                                        <th scope="col" class="responsive-px py-3">Saham</th>
                                        <th scope="col" class="responsive-px py-3">Tgl Ditambahkan</th>
                                        <th scope="col" class="responsive-px py-3 text-right">Harga Awal</th>
                                        <th scope="col" class="responsive-px py-3 text-right">Harga Terkini</th>
                                        <th scope="col" class="responsive-px py-3 text-right">Gain (%)</th>
                                        <th scope="col" class="responsive-px py-3 text-center">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="manual-performance-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                     <!-- Pagination for Manual Tracking -->
                    <div id="manual-pagination" class="hidden mt-4 flex flex-col sm:flex-row items-center justify-between gap-2">
                        <span id="manual-page-info" class="text-sm text-gray-600 mb-2 sm:mb-0"></span>
                        <div class="flex gap-2">
                            <button id="manual-prev-page" class="bg-white border border-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed text-sm">&laquo; Sebelumnya</button>
                            <button id="manual-next-page" class="bg-white border border-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed text-sm">Berikutnya &raquo;</button>
                        </div>
                    </div>
                </section>
            </div>

        </main>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast-notification" class="toast"></div>
    
    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Konfirmasi Penghapusan</h3>
            <p id="modal-message" class="text-gray-600 mb-6">Apakah Anda yakin ingin melanjutkan?</p>
            <div class="flex justify-end space-x-4">
                <button id="modal-cancel-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Batal</button>
                <button id="modal-confirm-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700">Ya, Hapus</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        document.addEventListener('DOMContentLoaded', function() {
            // --- Global Variables & Constants ---
            const stockData = [ { "ticker": "TLKM", "name": "Telkom Indonesia (Persero) Tbk.", "price": 3050, "isSyariah": true, "inSpecialMonitoring": false }, { "ticker": "ASII", "name": "Astra International Tbk.", "price": 5100, "isSyariah": true, "inSpecialMonitoring": false }, { "ticker": "BREN", "name": "Barito Renewables Energy Tbk", "price": 9000, "isSyariah": true, "inSpecialMonitoring": false }, { "ticker": "AMMN", "name": "Amman Mineral Internasional Tbk", "price": 11000, "isSyariah": true, "inSpecialMonitoring": false }, { "ticker": "UNVR", "name": "Unilever Indonesia Tbk.", "price": 3000, "isSyariah": true, "inSpecialMonitoring": false }, { "ticker": "ICBP", "name": "Indofood CBP Sukses Makmur Tbk.", "price": 11000, "isSyariah": true, "inSpecialMonitoring": false}, { "ticker": "MDKA", "name": "Merdeka Copper Gold Tbk.", "price": 2500, "isSyariah": true, "inSpecialMonitoring": true }, { "ticker": "ADRO", "name": "Adaro Energy Indonesia Tbk.", "price": 2700, "isSyariah": true, "inSpecialMonitoring": false }, { "ticker": "PTBA", "name": "Bukit Asam Tbk.", "price": 2500, "isSyariah": true, "inSpecialMonitoring": false }, { "ticker": "WIFI", "name": "Solusi Sinergi Digital Tbk.", "price": 60, "isSyariah": true, "inSpecialMonitoring": true }, { "ticker": "INDF", "name": "Indofood Sukses Makmur Tbk.", "price": 6200, "isSyariah": true, "inSpecialMonitoring": false }, { "ticker": "KLBF", "name": "Kalbe Farma Tbk.", "price": 1500, "isSyariah": true, "inSpecialMonitoring": false }, { "ticker": "CPIN", "name": "Charoen Pokphand Indonesia Tbk", "price": 5200, "isSyariah": true, "inSpecialMonitoring": false }, { "ticker": "EXCL", "name": "XL Axiata Tbk.", "price": 2300, "isSyariah": true, "inSpecialMonitoring": false }, { "ticker": "JSMR", "name": "Jasa Marga (Persero) Tbk.", "price": 5000, "isSyariah": true, "inSpecialMonitoring": false }, { "ticker": "AKRA", "name": "AKR Corporindo Tbk.", "price": 1600, "isSyariah": true, "inSpecialMonitoring": false }, { "ticker": "UNTR", "name": "United Tractors Tbk.", "price": 23000, "isSyariah": true, "inSpecialMonitoring": false }, { "ticker": "BRPT", "name": "Barito Pacific Tbk.", "price": 1000, "isSyariah": true, "inSpecialMonitoring": false }, { "ticker": "INCO", "name": "Vale Indonesia Tbk.", "price": 4000, "isSyariah": true, "inSpecialMonitoring": false }, { "ticker": "PGAS", "name": "Perusahaan Gas Negara Tbk.", "price": 1200, "isSyariah": true, "inSpecialMonitoring": false } ];
            const GEMINI_API_KEY = 'AIzaSyBpQvpC2Cs5_Y9UsNMJ_U4UQfY4YqQV7es';
            const GOOGLE_SHEET_API_URL = 'https://script.google.com/macros/s/AKfycbzn_lUgPbqVeLFqGboZth6OYBmW6ZXnQamp7s78M6yoOZK98nkXTSO4XcTxyizWTAj57Q/exec';
            const ITEMS_PER_PAGE = 10;
            const CACHE_DURATION_MS = 5 * 60 * 1000; // 5 menit
            
            let aiPerformanceData = [];
            let aiCurrentPage = 1;
            let manualPerformanceData = [];
            let manualCurrentPage = 1;

            // --- Firebase instances from global window object ---
            const db = window.db;
            const auth = window.auth;
            const { collection, addDoc, getDocs, query, where, Timestamp, deleteDoc, doc, signInAnonymously, onAuthStateChanged, orderBy, writeBatch } = window.firebase;
            
            // --- Modal Elements ---
            const modal = document.getElementById('confirmation-modal');
            const modalMessage = document.getElementById('modal-message');
            const modalConfirmBtn = document.getElementById('modal-confirm-btn');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');

            // --- Core Application Logic ---
            
            async function fetchStockPrice(ticker) {
                const url = `${GOOGLE_SHEET_API_URL}?ticker=${ticker}`;
                try {
                    const response = await fetch(url);
                    const data = await response.json();
                    if (data.price && data.ticker) {
                        const stockInfo = stockData.find(s => s.ticker === data.ticker);
                        return { ...data, name: stockInfo?.name || data.ticker };
                    }
                    return null;
                } catch (error) {
                    console.error(`Gagal mengambil harga untuk ${ticker}:`, error);
                    return null;
                }
            }

            async function triggerDailyRecommendation() {
                const statusEl = document.getElementById('ai-recommendation-status');
                const now = new Date();
                
                const todayStart = new Date();
                todayStart.setHours(0, 0, 0, 0);
                const q = query(collection(db, "ai_recommendations"), where("created_at", ">=", todayStart));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    statusEl.textContent = "Rekomendasi AI untuk hari ini telah diterima.";
                    return;
                }

                if (now.getHours() >= 8) {
                    statusEl.textContent = "Meminta rekomendasi AI untuk hari ini...";
                    await getAIRecommendations();
                } else {
                     statusEl.textContent = "Rekomendasi AI otomatis akan berjalan setelah pukul 08:00 pagi.";
                }
            }

            async function getAIRecommendations() {
                if (!db || !auth.currentUser) {
                    showToast("Autentikasi sedang diproses, silakan coba sesaat lagi.");
                    return;
                }
                try {
                    const todayStart = new Date();
                    todayStart.setHours(0, 0, 0, 0);
                    const q = query(collection(db, "ai_recommendations"), where("created_at", ">=", todayStart));
                    const querySnapshot = await getDocs(q);

                    if (!querySnapshot.empty) {
                        showToast("Rekomendasi untuk hari ini sudah ada.");
                        document.getElementById('ai-recommendation-status').textContent = "Rekomendasi AI untuk hari ini telah diterima.";
                        return;
                    }

                    const issiTickers = stockData.filter(s => s.isSyariah && !s.inSpecialMonitoring).map(s => s.ticker).join(', ');
                    const prompt = `Anda adalah seorang analis saham ahli. Dari daftar saham syariah (ISSI) berikut: ${issiTickers}, analisislah berdasarkan berita keuangan, laporan perusahaan, analisis pasar terkini, dan indikator teknikal (RSI, MFI, MACD, Volume, Stochastic, Moving Average). Berikan 4 saham yang paling direkomendasikan hari ini. Format jawabanmu HANYA sebagai daftar kode saham 4 huruf yang dipisahkan koma. PENTING: Saham pertama dalam daftar adalah yang paling Anda rekomendasikan. Contoh: TLKM,ADRO,ICBP,UNVR`;
                    
                    const recommendationText = await callGeminiAPI(prompt);
                    const tickers = recommendationText.split(',').map(t => t.trim().toUpperCase()).filter(t => t.length === 4);
                    
                    if (tickers.length === 0) {
                        showToast("AI tidak memberikan rekomendasi saat ini. Coba lagi nanti.");
                        return;
                    }

                    showToast(`AI merekomendasikan: ${tickers.join(', ')}. Menyimpan ke Firebase...`);

                    for (let i = 0; i < tickers.length; i++) {
                        const ticker = tickers[i];
                        const stockInfo = await fetchStockPrice(ticker);
                        if(stockInfo) {
                           await addDoc(collection(db, "ai_recommendations"), {
                                ticker: stockInfo.ticker,
                                name: stockInfo.name,
                                initial_price: stockInfo.price,
                                is_top_pick: i === 0,
                                created_at: Timestamp.fromDate(new Date())
                            });
                        }
                    }
                    
                    document.getElementById('ai-recommendation-status').textContent = "Rekomendasi AI untuk hari ini berhasil disimpan!";
                    await renderPerformance();

                } catch (error) {
                    showToast(`Gagal mendapatkan rekomendasi AI: ${error.message}`);
                    document.getElementById('ai-recommendation-status').textContent = `Gagal mendapatkan rekomendasi AI. Coba lagi nanti.`;
                    console.error("Error getting AI recommendation:", error);
                }
            }

            async function handleManualAnalysis() {
                const input = document.getElementById('manual-stock-input').value;
                const resultContainer = document.getElementById('manual-analysis-result');
                if (!input.trim()) { showToast("Silakan masukkan minimal satu kode saham."); return; }
                if (!GEMINI_API_KEY) { showToast('Kunci API Gemini belum dimasukkan ke dalam kode.'); return; }
                const tickers = input.split(',').map(t => t.trim().toUpperCase()).filter(t => t);
                resultContainer.innerHTML = `<div class="flex items-center justify-center py-8"><div class="loader"></div> <p class="ml-4 text-gray-500">AI sedang menganalisis...</p></div>`;
                try {
                    const prompt = `Anda adalah seorang analis teknikal dan fundamental ahli. Saya ingin Anda menganalisis dan membandingkan saham-saham berikut: ${tickers.join(', ')}. Untuk setiap saham, berikan analisis berdasarkan data terkini (asumsikan Anda memiliki akses ke data tersebut) yang mencakup: 1. Indikator Teknikal (RSI, Stochastic, MACD, MFI, Volume, Moving Average). 2. Aspek Fundamental (berita keuangan, ringkasan laporan perusahaan, analisis pasar umum). Setelah menganalisis setiap saham, berikan dua bagian kesimpulan. Pertama, bagian 'Urutan Rekomendasi' yang berisi daftar urutan saham dari yang paling direkomendasikan (peringkat 1) hingga yang kurang direkomendasikan. Kedua, bagian 'Rekomendasi Utama' yang menjelaskan secara ringkas saham mana yang menjadi pilihan teratas dan mengapa. Format jawaban Anda dengan heading tebal untuk setiap saham dan juga untuk 'Urutan Rekomendasi' dan 'Rekomendasi Utama'.`;
                    const analysisText = await callGeminiAPI(prompt);
                    resultContainer.innerHTML = analysisText
                        .replace(/\*\*(.*?)\*\*/g, '<h4>$1</h4>')
                        .replace(/\n/g, '<br>');
                } catch (error) {
                     resultContainer.innerHTML = `<p class="text-red-500 text-center">Terjadi kesalahan: ${error.message}</p>`;
                     console.error("Gemini API Error:", error);
                }
            }

            async function callGeminiAPI(prompt) {
                 const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
                 const payload = { contents: [{ parts: [{ text: prompt }] }] };
                 const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                 if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.error.message || 'Gagal berkomunikasi dengan API.'); }
                 const result = await response.json();
                 return result.candidates[0].content.parts[0].text;
            }
            
            async function removeStockFromAiRecs(id) {
                showConfirmationModal('Apakah Anda yakin ingin menghapus rekomendasi ini?', async () => {
                    try {
                        await deleteDoc(doc(db, "ai_recommendations", id));
                        showToast(`Rekomendasi berhasil dihapus.`);
                        localStorage.removeItem('ai_perf_daily');
                        localStorage.removeItem('ai_perf_weekly');
                        localStorage.removeItem('ai_perf_monthly');
                    } catch (error) {
                        showToast(`Gagal menghapus: ${error.message}`);
                        console.error("Error removing AI recommendation:", error);
                    }
                    const currentPeriod = document.querySelector('.time-filter-btn.active-filter').dataset.period;
                    await renderPerformance(currentPeriod);
                });
            }

            function displayAiPerformancePage(page) {
                aiCurrentPage = page;
                const tableBody = document.getElementById('performance-table-body');
                const paginationContainer = document.getElementById('ai-pagination');
                const pageInfo = document.getElementById('ai-page-info');
                const prevButton = document.getElementById('ai-prev-page');
                const nextButton = document.getElementById('ai-next-page');

                if (aiPerformanceData.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="7" class="text-center p-8 text-gray-500">Tidak ada data untuk ditampilkan.</td></tr>`;
                    paginationContainer.classList.add('hidden');
                    return;
                }
                
                const totalPages = Math.ceil(aiPerformanceData.length / ITEMS_PER_PAGE);
                const startIndex = (page - 1) * ITEMS_PER_PAGE;
                const endIndex = startIndex + ITEMS_PER_PAGE;
                const paginatedItems = aiPerformanceData.slice(startIndex, endIndex);

                tableBody.innerHTML = '';
                paginatedItems.forEach(data => {
                    const row = document.createElement('tr');
                    row.className = `bg-white border-b hover:bg-gray-50 ${data.is_top_pick ? 'top-pick-highlight' : ''}`;
                    const gainClass = data.gain > 0 ? 'positive-gain' : (data.gain < 0 ? 'negative-gain' : 'neutral-gain');
                    const gainIcon = data.gain > 0 ? 'fa-arrow-up' : 'fa-arrow-down';
                    row.innerHTML = `
                        <td class="responsive-px py-4"><input type="checkbox" class="rounded row-checkbox-ai" data-id="${data.id}"></td>
                        <td class="responsive-px py-4 font-medium text-gray-900 whitespace-nowrap">${data.ticker} ${data.is_top_pick ? '<i class="fas fa-star text-yellow-400 ml-1"></i>' : ''}</td>
                        <td class="responsive-px py-4">${data.date.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' })}</td>
                        <td class="responsive-px py-4 text-right">Rp ${Math.round(data.initialPrice).toLocaleString('id-ID')}</td>
                        <td class="responsive-px py-4 text-right">Rp ${Math.round(data.currentPrice).toLocaleString('id-ID')}</td>
                        <td class="responsive-px py-4 text-right"><span class="font-semibold ${gainClass}">${data.gain > 0 ? '+' : ''}${data.gain.toFixed(2)}% ${data.gain !== 0 ? `<i class="fas ${gainIcon} ml-1 text-xs"></i>` : ''}</span></td>
                        <td class="responsive-px py-4 text-center"><button data-id="${data.id}" class="remove-ai-btn text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button></td>`;
                    tableBody.appendChild(row);
                });

                document.querySelectorAll('.remove-ai-btn').forEach(button => { button.addEventListener('click', (e) => removeStockFromAiRecs(e.currentTarget.dataset.id)); });
                pageInfo.textContent = `Halaman ${page} dari ${totalPages}`;
                prevButton.disabled = page === 1;
                nextButton.disabled = page === totalPages;
                paginationContainer.classList.remove('hidden');

                document.querySelectorAll('.row-checkbox-ai').forEach(cb => cb.addEventListener('change', () => updateBulkDeleteUI('performance-table-body', 'bulk-delete-ai-btn')));
                updateBulkDeleteUI('performance-table-body', 'bulk-delete-ai-btn');
            }
            
            async function renderPerformance(period = 'daily') {
                const tableBody = document.getElementById('performance-table-body');
                const cacheKey = `ai_perf_${period}`;
                
                const cached = getFromCache(cacheKey);
                if (cached) {
                    aiPerformanceData = cached.map(item => ({...item, date: new Date(item.date) }));
                    displayAiPerformancePage(1);
                    tableBody.innerHTML += `<tr><td colspan="7" class="text-center p-2 text-xs text-blue-500 italic">Menampilkan data cache. Memuat data terbaru...</td></tr>`;
                } else {
                     tableBody.innerHTML = `<tr><td colspan="7" class="text-center p-8 text-gray-500">Memuat data performa...</td></tr>`;
                }

                if (!db || !auth.currentUser) { return; }

                let cutoffDate = new Date();
                if (period === 'daily') {
                    cutoffDate.setHours(0, 0, 0, 0); // Start of today
                } else {
                    const periodMap = { weekly: 7, monthly: 30 };
                    cutoffDate.setDate(cutoffDate.getDate() - (periodMap[period] || 0));
                }
                
                try {
                    const q = query(collection(db, "ai_recommendations"), where("created_at", ">=", cutoffDate));
                    const querySnapshot = await getDocs(q);
                    
                    if (querySnapshot.empty) {
                        aiPerformanceData = [];
                        displayAiPerformancePage(1);
                        return;
                    }

                    const tempPerformanceData = [];
                    for (const doc of querySnapshot.docs) {
                        const stock = doc.data();
                        const currentData = await fetchStockPrice(stock.ticker);
                        const initialPrice = stock.initial_price;
                        const recommendationDate = stock.created_at.toDate();
                        const currentPrice = currentData ? currentData.price : initialPrice;
                        const gain = ((currentPrice - initialPrice) / initialPrice) * 100;
                        tempPerformanceData.push({ ...stock, id: doc.id, date: recommendationDate, initialPrice, currentPrice, gain: parseFloat(gain.toFixed(2)) });
                    }

                    aiPerformanceData = tempPerformanceData.sort((a, b) => b.date - a.date);
                    saveToCache(cacheKey, aiPerformanceData);
                    displayAiPerformancePage(1);

                } catch (error) {
                    console.error("Error fetching performance data:", error);
                    tableBody.innerHTML = `<tr><td colspan="7" class="text-center p-8 text-red-500">Gagal memuat data performa.</td></tr>`;
                }
            }

            // --- Manual Tracking Functions ---
            async function addStockToManualTracking() {
                const input = document.getElementById('manual-track-input');
                const button = document.getElementById('add-manual-track-btn');
                const ticker = input.value.trim().toUpperCase();
                if (!ticker) { showToast("Silakan masukkan kode saham."); return; }
                button.disabled = true;
                button.innerHTML = `<div class="loader !w-5 !h-5 !border-2 mx-auto"></div>`;
                const stockInfo = await fetchStockPrice(ticker);
                if (!stockInfo) { 
                    showToast(`Saham dengan kode ${ticker} tidak ditemukan atau API gagal.`); 
                    button.disabled = false; 
                    button.innerHTML = `<i class="fas fa-plus mr-2"></i> Tambahkan`; 
                    return; 
                }
                
                try {
                    await addDoc(collection(db, "manual_tracking"), {
                        ticker: stockInfo.ticker,
                        initial_price: stockInfo.price,
                        created_at: Timestamp.fromDate(new Date())
                    });
                    showToast(`${ticker} berhasil ditambahkan ke daftar lacak.`);
                    input.value = '';
                } catch (error) {
                     showToast(`Gagal menambahkan ${ticker}: ${error.message}`);
                }
                
                await renderManualPerformance();
                button.disabled = false;
                button.innerHTML = `<i class="fas fa-plus mr-2"></i> Tambahkan`;
             }

            async function removeStockFromManualTracking(id) {
                 showConfirmationModal('Apakah Anda yakin ingin menghapus saham ini dari daftar lacak?', async () => {
                     try {
                         await deleteDoc(doc(db, "manual_tracking", id));
                         showToast(`Saham berhasil dihapus.`);
                         localStorage.removeItem('manual_perf');
                     } catch (error) {
                         showToast(`Gagal menghapus: ${error.message}`);
                     }
                     await renderManualPerformance();
                 });
            }

            function displayManualPerformancePage(page) {
                manualCurrentPage = page;
                const tableBody = document.getElementById('manual-performance-table-body');
                const paginationContainer = document.getElementById('manual-pagination');
                const pageInfo = document.getElementById('manual-page-info');
                const prevButton = document.getElementById('manual-prev-page');
                const nextButton = document.getElementById('manual-next-page');

                if (manualPerformanceData.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="7" class="text-center p-8 text-gray-500">Tidak ada data untuk ditampilkan.</td></tr>`;
                    paginationContainer.classList.add('hidden');
                    return;
                }

                const totalPages = Math.ceil(manualPerformanceData.length / ITEMS_PER_PAGE);
                const startIndex = (page - 1) * ITEMS_PER_PAGE;
                const endIndex = startIndex + ITEMS_PER_PAGE;
                const paginatedItems = manualPerformanceData.slice(startIndex, endIndex);

                tableBody.innerHTML = '';
                paginatedItems.forEach(data => {
                    const row = document.createElement('tr');
                    row.className = 'bg-white border-b hover:bg-gray-50';
                    const gainClass = data.gain > 0 ? 'positive-gain' : (data.gain < 0 ? 'negative-gain' : 'neutral-gain');
                    const gainIcon = data.gain > 0 ? 'fa-arrow-up' : 'fa-arrow-down';
                    row.innerHTML = `
                        <td class="responsive-px py-4"><input type="checkbox" class="rounded row-checkbox-manual" data-id="${data.id}"></td>
                        <td class="responsive-px py-4 font-medium text-gray-900 whitespace-nowrap">${data.ticker}</td>
                        <td class="responsive-px py-4">${data.date.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' })}</td>
                        <td class="responsive-px py-4 text-right">Rp ${Math.round(data.initialPrice).toLocaleString('id-ID')}</td>
                        <td class="responsive-px py-4 text-right">Rp ${Math.round(data.currentPrice).toLocaleString('id-ID')}</td>
                        <td class="responsive-px py-4 text-right"><span class="font-semibold ${gainClass}">${data.gain > 0 ? '+' : ''}${data.gain.toFixed(2)}% ${data.gain !== 0 ? `<i class="fas ${gainIcon} ml-1 text-xs"></i>` : ''}</span></td>
                        <td class="responsive-px py-4 text-center"><button data-id="${data.id}" class="remove-manual-btn text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button></td>`;
                    tableBody.appendChild(row);
                });

                document.querySelectorAll('.remove-manual-btn').forEach(button => { button.addEventListener('click', (e) => removeStockFromManualTracking(e.currentTarget.dataset.id)); });
                pageInfo.textContent = `Halaman ${page} dari ${totalPages}`;
                prevButton.disabled = page === 1;
                nextButton.disabled = page === totalPages;
                paginationContainer.classList.remove('hidden');

                document.querySelectorAll('.row-checkbox-manual').forEach(cb => cb.addEventListener('change', () => updateBulkDeleteUI('manual-performance-table-body', 'bulk-delete-manual-btn')));
                updateBulkDeleteUI('manual-performance-table-body', 'bulk-delete-manual-btn');
            }
            
            async function renderManualPerformance() {
                const tableBody = document.getElementById('manual-performance-table-body');
                const cacheKey = 'manual_perf';

                const cached = getFromCache(cacheKey);
                if (cached) {
                    manualPerformanceData = cached.map(item => ({...item, date: new Date(item.date) }));
                    displayManualPerformancePage(1);
                     tableBody.innerHTML += `<tr><td colspan="7" class="text-center p-2 text-xs text-blue-500 italic">Menampilkan data cache. Memuat data terbaru...</td></tr>`;
                } else {
                    tableBody.innerHTML = `<tr><td colspan="7" class="text-center p-8 text-gray-500">Memuat data dari Firestore...</td></tr>`;
                }

                if (!db || !auth.currentUser) { return; }

                try {
                    const q = query(collection(db, "manual_tracking"), orderBy("created_at", "desc"));
                    const querySnapshot = await getDocs(q);

                    if (querySnapshot.empty) { 
                        manualPerformanceData = [];
                        displayManualPerformancePage(1);
                        return; 
                    }
                
                    const tempPerformanceData = [];
                    for (const docSnapshot of querySnapshot.docs) {
                        const stock = docSnapshot.data();
                        const currentData = await fetchStockPrice(stock.ticker);
                        const initialPrice = stock.initial_price;
                        const addedDate = stock.created_at.toDate();
                        const currentPrice = currentData ? currentData.price : initialPrice;
                        const gain = ((currentPrice - initialPrice) / initialPrice) * 100;
                        tempPerformanceData.push({ ...stock, id: docSnapshot.id, date: addedDate, initialPrice, currentPrice, gain: parseFloat(gain.toFixed(2)) });
                    }
                    
                    manualPerformanceData = tempPerformanceData;
                    saveToCache(cacheKey, manualPerformanceData);
                    displayManualPerformancePage(manualCurrentPage || 1);
                
                } catch (error) {
                    tableBody.innerHTML = `<tr><td colspan="7" class="text-center p-8 text-red-500">Gagal memuat data.</td></tr>`; 
                    console.error("Error fetching manual tracking data:", error);
                }
            }

             // --- Bulk Delete Functions ---
            function updateBulkDeleteUI(tableBodyId, deleteButtonId) {
                const deleteButton = document.getElementById(deleteButtonId);
                const checkboxes = document.querySelectorAll(`#${tableBodyId} input[type="checkbox"]`);
                const selectedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
                if (selectedCount > 0) {
                    deleteButton.classList.remove('hidden');
                } else {
                    deleteButton.classList.add('hidden');
                }
            }
            
            async function handleBulkDelete(collectionName, tableBodyId, deleteButtonId, renderFn, cacheKeys) {
                const checkboxes = document.querySelectorAll(`#${tableBodyId} input[type="checkbox"]:checked`);
                const idsToDelete = Array.from(checkboxes).map(cb => cb.dataset.id);
                if (idsToDelete.length === 0) {
                    showToast('Tidak ada item yang dipilih.');
                    return;
                }

                showConfirmationModal(`Apakah Anda yakin ingin menghapus ${idsToDelete.length} item terpilih?`, async () => {
                    const deleteButton = document.getElementById(deleteButtonId);
                    deleteButton.disabled = true;
                    deleteButton.innerHTML = `<div class="loader !w-4 !h-4 !border-2 mx-auto"></div>`;

                    try {
                        const batch = writeBatch(db);
                        idsToDelete.forEach(id => {
                            const docRef = doc(db, collectionName, id);
                            batch.delete(docRef);
                        });
                        await batch.commit();
                        showToast(`${idsToDelete.length} item berhasil dihapus.`);
                        cacheKeys.forEach(key => localStorage.removeItem(key));
                    } catch (error) {
                        showToast(`Gagal menghapus item: ${error.message}`);
                        console.error('Bulk delete error:', error);
                    } finally {
                        deleteButton.disabled = false;
                        deleteButton.innerHTML = `<i class="fas fa-trash-alt mr-2"></i>Hapus Terpilih`;
                        deleteButton.classList.add('hidden');
                        await renderFn();
                    }
                });
            }


            // --- Caching Functions ---
            function saveToCache(key, data) {
                const cacheData = {
                    timestamp: Date.now(),
                    data: data
                };
                localStorage.setItem(key, JSON.stringify(cacheData));
            }

            function getFromCache(key) {
                const cached = localStorage.getItem(key);
                if (!cached) return null;

                const { timestamp, data } = JSON.parse(cached);
                if (Date.now() - timestamp > CACHE_DURATION_MS) {
                    localStorage.removeItem(key);
                    return null;
                }
                return data;
            }

            // --- UI & Event Handlers ---
            function handleTabClick(event) {
                const tabButtons = document.querySelectorAll('.tab-btn');
                tabButtons.forEach(btn => {
                    btn.classList.remove('active');
                    btn.classList.add('border-transparent', 'text-gray-500', 'font-medium');
                    btn.classList.remove('font-semibold')
                });
                event.target.classList.add('active');
                event.target.classList.remove('border-transparent', 'text-gray-500');
                event.target.classList.add('font-semibold');
                document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                const targetId = `tab-content-${event.target.id.split('-')[2]}`;
                document.getElementById(targetId).classList.remove('hidden');

                if (targetId === 'tab-content-tracking') {
                    renderManualPerformance();
                }
                 if (targetId === 'tab-content-dashboard') {
                    const currentPeriod = document.querySelector('.time-filter-btn.active-filter').dataset.period;
                    renderPerformance(currentPeriod);
                }
            }
            
            function setDate() { document.getElementById('current-date').textContent = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); }
            function showToast(message) { const toast = document.getElementById('toast-notification'); toast.textContent = message; toast.classList.add('show'); setTimeout(() => { toast.classList.remove('show'); }, 3000); }
            
             // --- Modal Functions ---
            function showConfirmationModal(message, onConfirm) {
                modalMessage.textContent = message;
                modal.classList.remove('hidden');

                modalConfirmBtn.onclick = () => {
                    onConfirm();
                    hideModal();
                };
            }

            function hideModal() {
                modal.classList.add('hidden');
                modalConfirmBtn.onclick = null; // Hapus listener agar tidak menumpuk
            }


            // --- APPLICATION INITIALIZATION ---
            function initAuth() {
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        console.log("Authenticated anonymously with UID:", user.uid);
                        initializeAppLogic(); 
                    } else {
                        console.log("User not authenticated. Signing in...");
                        signInAnonymously(auth).catch(error => {
                            console.error("Anonymous sign-in failed:", error);
                            showToast("Gagal mengautentikasi. Fitur database tidak akan berfungsi.");
                        });
                    }
                });
            }

            async function initializeAppLogic() {
                setDate();
                
                // Modal Listeners
                modalCancelBtn.addEventListener('click', hideModal);
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) { // Hanya tutup jika klik di overlay
                        hideModal();
                    }
                });
                
                // Pagination Listeners
                document.getElementById('ai-prev-page').addEventListener('click', () => displayAiPerformancePage(aiCurrentPage - 1));
                document.getElementById('ai-next-page').addEventListener('click', () => displayAiPerformancePage(aiCurrentPage + 1));
                document.getElementById('manual-prev-page').addEventListener('click', () => displayManualPerformancePage(manualCurrentPage - 1));
                document.getElementById('manual-next-page').addEventListener('click', () => displayManualPerformancePage(manualCurrentPage + 1));
                
                // Other Listeners
                document.querySelectorAll('.time-filter-btn').forEach(button => { 
                    button.addEventListener('click', function() { 
                        document.querySelectorAll('.time-filter-btn').forEach(btn => btn.classList.remove('active-filter', 'font-semibold')); 
                        this.classList.add('active-filter', 'font-semibold'); 
                        renderPerformance(this.dataset.period); 
                    }); 
                });
                document.getElementById('tab-btn-dashboard').addEventListener('click', handleTabClick);
                document.getElementById('tab-btn-manual').addEventListener('click', handleTabClick);
                document.getElementById('tab-btn-tracking').addEventListener('click', handleTabClick);
                document.getElementById('manual-analyze-btn').addEventListener('click', handleManualAnalysis);
                document.getElementById('add-manual-track-btn').addEventListener('click', addStockToManualTracking);
                document.getElementById('get-ai-recommendation-btn')?.addEventListener('click', getAIRecommendations);

                 // Bulk Delete Listeners
                document.getElementById('bulk-delete-ai-btn').addEventListener('click', () => handleBulkDelete('ai_recommendations', 'performance-table-body', 'bulk-delete-ai-btn', () => renderPerformance(document.querySelector('.time-filter-btn.active-filter').dataset.period), ['ai_perf_daily', 'ai_perf_weekly', 'ai_perf_monthly']));
                document.getElementById('bulk-delete-manual-btn').addEventListener('click', () => handleBulkDelete('manual_tracking', 'manual-performance-table-body', 'bulk-delete-manual-btn', renderManualPerformance, ['manual_perf']));
                
                // Select All Listeners
                document.getElementById('select-all-ai').addEventListener('change', (e) => {
                    document.querySelectorAll('.row-checkbox-ai').forEach(cb => cb.checked = e.target.checked);
                    updateBulkDeleteUI('performance-table-body', 'bulk-delete-ai-btn');
                });
                document.getElementById('select-all-manual').addEventListener('change', (e) => {
                    document.querySelectorAll('.row-checkbox-manual').forEach(cb => cb.checked = e.target.checked);
                    updateBulkDeleteUI('manual-performance-table-body', 'bulk-delete-manual-btn');
                });

                // Initial data load
                renderPerformance();
                triggerDailyRecommendation();
            }

            // Start the authentication process.
            initAuth();
        });
    </script>
</body>
</html>

